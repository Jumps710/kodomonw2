<script>
const params = new URLSearchParams(window.location.search);
const userId = params.get("userId");
const siteName = params.get("siteName");
const nickname = params.get("nickname");
const BACKEND_URL = "https://script.google.com/macros/s/AKfycby3AtgmX1gCDd2KUeYT8TkUBkVKoh_VH0q3oflLp6Bp3tse0SOETZgGV9wgiP8fT4FY/exec";
let imageFileBase64 = "";

window.onload = function() {
    document.getElementById("formTitle").textContent = `${siteName} ${nickname}さん 活動報告を入力してください。`;
};

// 画像アップロード時の圧縮処理
document.getElementById("imageUpload").addEventListener("change", async (e) => {
    const file = e.target.files[0];
    document.querySelector('.file-name').textContent = file ? file.name : "未選択";

    if (file) {
        const reader = new FileReader();
        reader.onload = async (e) => {
            const base64Data = e.target.result;
            imageFileBase64 = await compressImage(base64Data);
            console.log("圧縮後のBase64長さ: ", imageFileBase64.length); // ログ出力
            document.getElementById("photoPreview").innerHTML = `<img src="data:image/jpeg;base64,${imageFileBase64}" width="150">`;
        };
        reader.readAsDataURL(file);
    }
});

// 圧縮関数
async function compressImage(base64Data) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const maxWidth = 800;
            const maxHeight = 600;
            let width = img.width;
            let height = img.height;

            if (width > maxWidth) {
                height = Math.round((height * maxWidth) / width);
                width = maxWidth;
            }
            if (height > maxHeight) {
                width = Math.round((width * maxHeight) / height);
                height = maxHeight;
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            const compressed = canvas.toDataURL('image/jpeg', 0.7);
            const base64DataCompressed = compressed.split(',')[1];
            resolve(base64DataCompressed);
        };
        img.src = base64Data;
    });
}

document.getElementById("submitReport").addEventListener("click", (e) => {
    e.preventDefault();
    const eventDate = document.getElementById("eventDate").value;
    const eventType = document.getElementById("eventType").value;
    const adults = document.getElementById("adults").value;
    const children = document.getElementById("children").value;
    const comments = document.getElementById("comments").value;

    document.getElementById("confirmDate").textContent = eventDate;
    document.getElementById("confirmType").textContent = eventType;
    document.getElementById("confirmAdults").textContent = adults;
    document.getElementById("confirmChildren").textContent = children;
    document.getElementById("confirmComments").textContent = comments;

    if (imageFileBase64) {
        document.getElementById("confirmImagePreview").innerHTML = `<img src="data:image/jpeg;base64,${imageFileBase64}" width="100">`;
    } else {
        document.getElementById("confirmImagePreview").innerHTML = "画像なし";
    }

    document.getElementById("confirmationModal").style.display = "flex";
});

document.getElementById("confirmSubmit").addEventListener("click", async () => {
    document.getElementById("loadingMsg").style.display = "block";

    const data = new URLSearchParams({
        action: "report_submit",
        userId,
        siteName,
        nickname,
        eventDate: document.getElementById("eventDate").value,
        eventType: document.getElementById("eventType").value,
        adults: document.getElementById("adults").value,
        children: document.getElementById("children").value,
        comments: document.getElementById("comments").value,
        imageBase64: imageFileBase64
    });

    try {
        const response = await fetch(BACKEND_URL, {
            method: "POST",
            body: data
        });
        const result = await response.json();
        document.getElementById("loadingMsg").style.display = "none";
        if (result.status === "success") {
            alert("活動報告が完了しました！");
            closeModal();
            document.getElementById("reportForm").reset();
            imageFileBase64 = "";
        } else {
            alert("エラーが発生しました: " + result.message);
        }
    } catch (error) {
        alert("送信に失敗しました。再度お試しください。");
        console.error("送信エラー:", error);
    }
});

function closeModal() {
    document.getElementById("confirmationModal").style.display = "none";
}
</script>
